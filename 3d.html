<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Sky Racer - Multiplayer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87ceeb; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 2px 2px 4px #000; pointer-events: none; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 20px; color: white; text-align: center; border-radius: 10px; pointer-events: all; }
        input { padding: 10px; border-radius: 5px; border: none; margin: 10px 0; width: 200px; }
        button { padding: 10px 20px; cursor: pointer; background: #2ecc71; border: none; color: white; font-weight: bold; }
        .controls { position: absolute; bottom: 20px; left: 20px; color: white; font-size: 0.8em; }
    </style>
</head>
<body>

<div id="ui">
    <div id="speed">Speed: 0 kn</div>
    <div id="status">Multiplayer: Offline</div>
</div>

<div id="menu">
    <h1>Sky Racer 3D</h1>
    <p>Share ID to Race</p>
    <input type="text" id="peer-id-display" readonly placeholder="Your ID..."><br>
    <input type="text" id="remote-id" placeholder="Friend's ID..."><br>
    <button onclick="connectToPeer()">Connect & Race</button>
    <button onclick="startSolo()">Fly Solo</button>
</div>

<div class="controls">
    WASD / Arrows: Pitch & Roll | Q/E: Yaw | Shift: Throttle Up
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

<script>
/** * GAME CONFIG & STATE 
 **/
let scene, camera, renderer, plane, clock;
let otherPlanes = {};
let peer, conn;
let keys = {};
const flightData = { speed: 0, roll: 0, pitch: 0, yaw: 0 };

// Initialize Game
function init() {
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x87ceeb, 100, 1000);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x87ceeb);
    document.body.appendChild(renderer.domElement);

    // Lighting
    const sun = new THREE.DirectionalLight(0xffffff, 1);
    sun.position.set(10, 20, 10);
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0x404040));

    // World: Ocean and Rings
    createWorld();

    // Player Plane
    plane = createPlane(0xff0000);
    scene.add(plane);
    
    clock = new THREE.Clock();
    animate();
}

function createPlane(color) {
    const group = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(1, 0.5, 3), new THREE.MeshStandardMaterial({ color }));
    const wings = new THREE.Mesh(new THREE.BoxGeometry(4, 0.1, 1), new THREE.MeshStandardMaterial({ color }));
    group.add(body, wings);
    return group;
}

function createWorld() {
    // Ocean
    const ocean = new THREE.Mesh(
        new THREE.PlaneGeometry(5000, 5000),
        new THREE.MeshStandardMaterial({ color: 0x0077be })
    );
    ocean.rotation.x = -Math.PI / 2;
    ocean.position.y = -50;
    scene.add(ocean);

    // Race Rings
    for(let i = 0; i < 20; i++) {
        const ring = new THREE.Mesh(
            new THREE.TorusGeometry(10, 0.5, 16, 100),
            new THREE.MeshStandardMaterial({ color: 0xffff00 })
        );
        ring.position.set(Math.sin(i) * 50, 20 + (i * 5), i * -150);
        scene.add(ring);
    }
}

/** * MULTIPLAYER LOGIC 
 **/
peer = new Peer();
peer.on('open', (id) => {
    document.getElementById('peer-id-display').value = id;
});

peer.on('connection', (c) => {
    setupConn(c);
});

function connectToPeer() {
    const remoteId = document.getElementById('remote-id').value;
    if (remoteId) {
        setupConn(peer.connect(remoteId));
    }
}

function setupConn(c) {
    conn = c;
    document.getElementById('status').innerText = "Multiplayer: Connected";
    document.getElementById('menu').style.display = 'none';
    
    conn.on('data', (data) => {
        if (!otherPlanes[data.id]) {
            otherPlanes[data.id] = createPlane(0x00ff00);
            scene.add(otherPlanes[data.id]);
        }
        otherPlanes[data.id].position.copy(data.pos);
        otherPlanes[data.id].rotation.copy(data.rot);
    });
}

function startSolo() {
    document.getElementById('menu').style.display = 'none';
}

/** * GAME LOOP & CONTROLS 
 **/
window.addEventListener('keydown', (e) => keys[e.code] = true);
window.addEventListener('keyup', (e) => keys[e.code] = false);

function handleMovement() {
    if (keys['ShiftLeft']) flightData.speed = Math.min(flightData.speed + 0.01, 1.5);
    else flightData.speed = Math.max(flightData.speed - 0.005, 0.2);

    if (keys['KeyW']) plane.rotateX(0.02);
    if (keys['KeyS']) plane.rotateX(-0.02);
    if (keys['KeyA']) plane.rotateZ(0.03);
    if (keys['KeyD']) plane.rotateZ(-0.03);
    if (keys['KeyQ']) plane.rotateY(0.02);
    if (keys['KeyE']) plane.rotateY(-0.02);

    plane.translateZ(-flightData.speed);
    
    // Sync to Peer
    if (conn && conn.open) {
        conn.send({
            id: peer.id,
            pos: plane.position,
            rot: plane.rotation
        });
    }

    document.getElementById('speed').innerText = `Speed: ${Math.round(flightData.speed * 100)} kn`;
}

function animate() {
    requestAnimationFrame(animate);
    handleMovement();

    // Camera follow
    const offset = new THREE.Vector3(0, 5, 15).applyQuaternion(plane.quaternion);
    camera.position.copy(plane.position).add(offset);
    camera.lookAt(plane.position);

    renderer.render(scene, camera);
}

init();

// Handle resizing
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>